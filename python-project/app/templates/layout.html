{% extends "base.html" %}
{% block body %}
<div class="min-h-screen flex flex-col">

    <!-- Mobile menu overlay -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black/60 z-30 hidden" onclick="toggleMobileMenu()"></div>

    <!-- ═══ Top Navbar ═══ -->
    <header class="sticky top-0 z-40 bg-surface-900 border-b border-surface-800">
        <!-- Primary bar: logo, user, hamburger -->
        <div class="flex items-center justify-between px-4 sm:px-6 lg:px-8 py-3">
            <!-- Logo -->
            <a href="/dashboard" class="flex items-center gap-3 flex-shrink-0">
                <div class="w-9 h-9 rounded-xl bg-brand-600 flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 7000 7000" xmlns="http://www.w3.org/2000/svg">
                        <g>
                            <path d="M3534.57 2921.26l509.33 278.51 0 600.85 -543.85 297.38 -543.84 -297.38 0 -600.85 543.84 -297.38 34.51 18.87zm166.69 255.62l-201.2 -110.02 -399.01 218.18 0 430.3 399.01 218.19 399.01 -218.19 0 -430.3 -197.81 -108.16z"/>
                            <path d="M3206.76 1423.91l672.75 0 0 1366.1 -745.17 0 0 -1366.1 72.42 0zm527.92 144.83l-455.5 0 0 1076.43 455.5 0 0 -1076.43z"/>
                            <polygon points="3436.12,1496.03 3436.12,899.79 3580.96,899.79 3580.96,1496.03"/>
                            <polygon points="3432.32,3004.16 3432.32,2675.89 3577.15,2675.89 3577.15,3004.16"/>
                            <path d="M3203.34 5576.08l672.75 0 0 -1366.09 -745.17 0 0 1366.09 72.42 0zm527.92 -144.83l-455.5 0 0 -1076.43 455.5 0 0 -1076.43z"/>
                            <polygon points="3432.7,5503.96 3432.7,6100.2 3577.53,6100.2 3577.53,5503.96"/>
                            <polygon points="3428.89,3986.69 3428.89,4314.95 3573.73,4314.95 3573.73,3986.69"/>
                            <path d="M5172.55 4811.44l336.37 -582.62 -1183.07 -683.05 -372.59 645.33 1183.07 683.05 36.21 -62.72zm138.53 -529.61l-227.75 394.48 -932.21 -538.21 227.75 -394.48 932.21 538.21z"/>
                            <polygon points="5224.77,4576.75 5741.13,4874.87 5813.54,4749.44 5297.19,4451.32"/>
                            <polygon points="3908.87,3821.41 4193.16,3985.54 4265.57,3860.11 3981.29,3695.98"/>
                            <path d="M5479.29 2714.84l-336.37 -582.62 -1183.07 683.05 372.58 645.33 1183.07 -683.05 -36.21 -62.71zm-389.39 -384.77l227.75 394.47 -932.21 538.21 -227.75 -394.47 932.21 -538.21z"/>
                            <polygon points="5302.15,2552.27 5818.51,2254.15 5746.09,2128.72 5229.73,2426.84"/>
                            <polygon points="3990.05,3314.2 4274.34,3150.07 4201.92,3024.64 3917.63,3188.77"/>
                            <path d="M1829.86 4820.48l-336.38 -582.62 1183.07 -683.05 372.59 645.33 -1183.07 683.05 -36.21 -62.72zm-138.53 -529.61l227.75 394.47 932.21 -538.21 -227.75 -394.47 -932.21 538.21z"/>
                            <polygon points="1777.64,4585.79 1261.28,4883.91 1188.87,4758.48 1705.22,4460.36"/>
                            <polygon points="3093.54,3830.44 2809.25,3994.57 2736.83,3869.15 3021.12,3705.01"/>
                            <path d="M1520.7 2723.73l336.38 -582.62 1183.07 683.05 -372.58 645.33 -1183.07 -683.05 36.21 -62.72zm389.39 -384.77l-227.75 394.47 932.21 538.22 227.75 -394.48 -932.21 -538.21z"/>
                            <polygon points="1697.84,2561.16 1181.48,2263.04 1253.9,2137.61 1770.26,2435.73"/>
                            <polygon points="3009.94,3323.09 2725.65,3158.96 2798.07,3033.53 3082.35,3197.66"/>
                        </g>
                    </svg>
                </div>
                <span class="text-lg font-bold text-white tracking-tight">{{ app_name }}</span>
            </a>

            <!-- Desktop nav links -->
            <nav class="hidden xl:flex items-center gap-1 mx-6 flex-1 justify-center">
                {% set nav_items = [
                    ('dashboard', '/dashboard', 'layout-dashboard', 'Dashboard'),
                    ('brokers', '/brokers', 'landmark', 'Brokers'),
                ] %}
                {% for page, href, icon, label in nav_items %}
                <a href="{{ href }}"
                   class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200
                          {% if active_page == page %}bg-brand-600 text-white shadow-md shadow-brand-600/25{% else %}text-surface-300 hover:bg-surface-800 hover:text-white{% endif %}">
                    <i data-lucide="{{ icon }}" class="w-3.5 h-3.5"></i>
                    <span>{{ label }}</span>
                </a>
                {% endfor %}

                <!-- API dropdown -->
                <div class="relative" id="api-dropdown">
                    <button onclick="toggleApiDropdown()" type="button"
                        class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200
                               {% if active_page in ['instruments_api','account_details_api','order_api','trading_api','market_data_api','chart_image_api','news_api','event_ids','scrape_api'] %}bg-brand-600 text-white shadow-md shadow-brand-600/25{% else %}text-surface-300 hover:bg-surface-800 hover:text-white{% endif %}">
                        <i data-lucide="code" class="w-3.5 h-3.5"></i>
                        <span>APIs</span>
                        <i data-lucide="chevron-down" class="w-3 h-3 ml-0.5"></i>
                    </button>
                    <div id="api-dropdown-menu" class="hidden absolute top-full left-0 mt-2 w-56 bg-surface-850 border border-surface-700 rounded-xl shadow-2xl py-2 z-50">
                        {% set api_items = [
                            ('instruments_api', '/instruments-api', 'file-code', 'Instruments'),
                            ('account_details_api', '/account-details-api', 'user-circle', 'Account Details'),
                            ('order_api', '/order-api', 'list-ordered', 'Orders'),
                            ('trading_api', '/trading-api', 'arrow-left-right', 'Trading'),
                            ('market_data_api', '/market-data-api', 'candlestick-chart', 'Market Data'),
                            ('chart_image_api', '/chart-image-api', 'image', 'Chart Image'),
                            ('news_api', '/news-api', 'newspaper', 'News'),
                            ('event_ids', '/event-ids', 'hash', 'Event IDs'),
                            ('scrape_api', '/scrape-api', 'globe', 'Scrape'),
                        ] %}
                        {% for page, href, icon, label in api_items %}
                        <a href="{{ href }}"
                           class="flex items-center gap-3 px-4 py-2.5 text-sm transition-all duration-150
                                  {% if active_page == page %}bg-brand-600/20 text-brand-400{% else %}text-surface-300 hover:bg-surface-800 hover:text-white{% endif %}">
                            <i data-lucide="{{ icon }}" class="w-4 h-4 flex-shrink-0"></i>
                            <span>{{ label }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Tools dropdown -->
                <div class="relative" id="tools-dropdown">
                    <button onclick="toggleToolsDropdown()" type="button"
                        class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200
                               {% if active_page in ['mcp_server','tmp_guide','install'] %}bg-brand-600 text-white shadow-md shadow-brand-600/25{% else %}text-surface-300 hover:bg-surface-800 hover:text-white{% endif %}">
                        <i data-lucide="wrench" class="w-3.5 h-3.5"></i>
                        <span>Tools</span>
                        <i data-lucide="chevron-down" class="w-3 h-3 ml-0.5"></i>
                    </button>
                    <div id="tools-dropdown-menu" class="hidden absolute top-full left-0 mt-2 w-48 bg-surface-850 border border-surface-700 rounded-xl shadow-2xl py-2 z-50">
                        {% set tool_items = [
                            ('mcp_server', '/mcp-server', 'cpu', 'MCP Server'),
                            ('tmp_guide', '/tmp-guide', 'search', 'TMP Protocol'),
                            ('install', '/install', 'download', 'Install Guide'),
                        ] %}
                        {% for page, href, icon, label in tool_items %}
                        <a href="{{ href }}"
                           class="flex items-center gap-3 px-4 py-2.5 text-sm transition-all duration-150
                                  {% if active_page == page %}bg-brand-600/20 text-brand-400{% else %}text-surface-300 hover:bg-surface-800 hover:text-white{% endif %}">
                            <i data-lucide="{{ icon }}" class="w-4 h-4 flex-shrink-0"></i>
                            <span>{{ label }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <a href="/settings"
                   class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200
                          {% if active_page == 'settings' %}bg-brand-600 text-white shadow-md shadow-brand-600/25{% else %}text-surface-300 hover:bg-surface-800 hover:text-white{% endif %}">
                    <i data-lucide="settings" class="w-3.5 h-3.5"></i>
                    <span>Settings</span>
                </a>
            </nav>

            <!-- Right side: user + logout + hamburger -->
            <div class="flex items-center gap-3">
                <div class="hidden sm:flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-brand-600/20 flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-brand-400"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-white leading-tight">{{ user.first_name }} {{ user.last_name }}</p>
                        <p class="text-xs text-surface-400">{{ user.email }}</p>
                    </div>
                </div>
                <a href="/logout"
                   class="flex items-center gap-2 text-sm text-surface-400 hover:text-white border border-surface-700 hover:border-surface-400 px-3 py-2 rounded-lg transition-all duration-200">
                    <i data-lucide="log-out" class="w-4 h-4 flex-shrink-0"></i>
                    <span class="hidden sm:inline">Sign Out</span>
                </a>
                <!-- Hamburger (mobile/tablet) -->
                <button onclick="toggleMobileMenu()" class="xl:hidden p-2 rounded-lg text-surface-400 hover:text-white hover:bg-surface-800 transition-colors">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Mobile menu -->
        <nav id="mobile-menu" class="hidden xl:hidden border-t border-surface-800 bg-surface-900 max-h-[70vh] overflow-y-auto scrollbar-thin">
            <div class="px-4 py-4 space-y-1">
                {% set all_nav = [
                    ('dashboard', '/dashboard', 'layout-dashboard', 'Dashboard'),
                    ('brokers', '/brokers', 'landmark', 'Brokers'),
                    ('instruments_api', '/instruments-api', 'file-code', 'Instruments API'),
                    ('account_details_api', '/account-details-api', 'user-circle', 'Account Details API'),
                    ('order_api', '/order-api', 'list-ordered', 'Order API'),
                    ('trading_api', '/trading-api', 'arrow-left-right', 'Trading API'),
                    ('market_data_api', '/market-data-api', 'candlestick-chart', 'Market Data API'),
                    ('chart_image_api', '/chart-image-api', 'image', 'Chart Image API'),
                    ('news_api', '/news-api', 'newspaper', 'News API'),
                    ('event_ids', '/event-ids', 'hash', 'Event ID Reference'),
                    ('scrape_api', '/scrape-api', 'globe', 'Scrape API'),
                    ('mcp_server', '/mcp-server', 'cpu', 'MCP Server'),
                    ('tmp_guide', '/tmp-guide', 'search', 'TMP Protocol'),
                    ('install', '/install', 'download', 'Install Guide'),
                    ('settings', '/settings', 'settings', 'Settings'),
                ] %}
                {% for page, href, icon, label in all_nav %}
                <a href="{{ href }}"
                   class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200
                          {% if active_page == page %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                    <i data-lucide="{{ icon }}" class="w-4 h-4 flex-shrink-0"></i>
                    <span>{{ label }}</span>
                </a>
                {% endfor %}
            </div>
            <!-- Attribution in mobile menu — required by license -->
            <div class="px-4 py-4 border-t border-surface-800" id="arrissa-credit" data-arrissa="vestorfinance">
                <p class="text-xs text-surface-400 text-center">&copy; 2026 {{ app_name }} &middot; v1.0</p>
                <p class="text-[10px] text-surface-500 text-center mt-1">
                    Powered by <a href="https://arrissadata.com" target="_blank" class="text-surface-400 hover:text-brand-400 transition">Arrissa</a>
                    &middot; <a href="https://arrissa.trade" target="_blank" class="text-surface-400 hover:text-brand-400 transition">arrissa.trade</a>
                </p>
                <p class="text-[10px] text-surface-500 text-center mt-0.5">
                    Created by <a href="https://arrissacapital.com" target="_blank" class="text-surface-400 hover:text-brand-400 transition">Arrissa Pty Ltd</a>
                    &middot; <a href="https://instagram.com/davidrichchild" target="_blank" class="text-surface-400 hover:text-brand-400 transition">Ngonidzashe Jiji (David Richchild)</a>
                </p>
            </div>
        </nav>
    </header>

    <!-- ═══ Main content ═══ -->
    <main class="flex-1">
        <!-- Page title bar -->
        <div class="bg-surface-950 border-b border-surface-800">
            <div class="px-4 sm:px-6 lg:px-8 py-4">
                <h2 class="text-lg lg:text-xl font-bold text-white">{% block page_title %}Dashboard{% endblock %}</h2>
            </div>
        </div>

        <div class="px-4 sm:px-6 lg:px-8 py-6 lg:py-8">
            <!-- Update notification banner -->
            <div id="update-banner" class="hidden mb-6 bg-indigo-900/30 border border-indigo-700/50 rounded-2xl overflow-hidden">
                <div class="px-5 py-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-indigo-600/30 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="download-cloud" class="w-5 h-5 text-indigo-400"></i>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-white">Update Available</p>
                            <p class="text-xs text-indigo-300" id="update-summary"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <button onclick="document.getElementById('update-details').classList.toggle('hidden'); lucide.createIcons();"
                            class="text-xs text-indigo-300 hover:text-white px-3 py-1.5 bg-indigo-800/40 hover:bg-indigo-700/50 rounded-lg transition">
                            View Changes
                        </button>
                        <button id="update-now-btn" onclick="runUpdate()"
                            class="text-xs text-white font-semibold px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg transition">
                            Update Now
                        </button>
                        <button onclick="document.getElementById('update-banner').classList.add('hidden')"
                            class="text-xs text-indigo-400 hover:text-white p-1.5 rounded-lg transition">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Expandable details -->
                <div id="update-details" class="hidden border-t border-indigo-700/30">
                    <!-- Changelog -->
                    <div class="px-5 py-4">
                        <p class="text-xs font-semibold text-indigo-300 uppercase tracking-wider mb-3">What's New</p>
                        <div id="update-changelog" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    </div>
                    <!-- Update command -->
                    <div class="px-5 py-4 bg-gray-950/50 border-t border-indigo-700/30">
                        <p class="text-xs font-semibold text-indigo-300 uppercase tracking-wider mb-2">Update Command</p>
                        <p class="text-xs text-gray-400 mb-3">SSH into your server and paste this command:</p>
                        <div class="relative">
                            <pre id="update-cmd" class="bg-gray-900 border border-gray-700 rounded-xl p-4 text-sm font-mono text-green-400 overflow-x-auto whitespace-pre-wrap pr-16"></pre>
                            <button onclick="navigator.clipboard.writeText(document.getElementById('update-cmd').textContent).then(()=>{this.textContent='Copied!'; setTimeout(()=>this.textContent='Copy',2000)})"
                                class="absolute top-3 right-3 text-xs text-gray-400 hover:text-indigo-400 px-3 py-1.5 bg-gray-800 rounded-lg transition">Copy</button>
                        </div>
                    </div>
                </div>
            </div>

            {% if message %}
            <div class="flash-msg flex flex-row items-center gap-3 bg-green-900/30 border border-green-800 text-green-300 px-5 py-4 rounded-xl mb-6 text-sm transition-opacity duration-500">
                <i data-lucide="check-circle-2" class="w-5 h-5 flex-shrink-0"></i>
                <span>{{ message }}</span>
            </div>
            {% endif %}
            {% if error %}
            <div class="flash-msg flex flex-row items-center gap-3 bg-red-900/30 border border-red-800 text-red-300 px-5 py-4 rounded-xl mb-6 text-sm transition-opacity duration-500">
                <i data-lucide="alert-circle" class="w-5 h-5 flex-shrink-0"></i>
                <span>{{ error }}</span>
            </div>
            {% endif %}

            {% block content %}{% endblock %}
        </div>
    <!-- Footer attribution — required by license -->
    <footer class="border-t border-surface-800 py-4" id="arrissa-credit" data-arrissa="vestorfinance">
        <p class="text-xs text-surface-400 text-center">&copy; 2026 {{ app_name }} &middot; v1.0</p>
        <p class="text-[10px] text-surface-500 text-center mt-1">
            Powered by <a href="https://arrissadata.com" target="_blank" class="text-surface-400 hover:text-brand-400 transition">Arrissa</a>
            &middot; <a href="https://arrissa.trade" target="_blank" class="text-surface-400 hover:text-brand-400 transition">arrissa.trade</a>
            &middot; Created by <a href="https://arrissacapital.com" target="_blank" class="text-surface-400 hover:text-brand-400 transition">Arrissa Pty Ltd</a>
            &middot; <a href="https://instagram.com/davidrichchild" target="_blank" class="text-surface-400 hover:text-brand-400 transition">Ngonidzashe Jiji (David Richchild)</a>
        </p>
    </footer>
</div>

<script>
function toggleMobileMenu() {
    const menu = document.getElementById('mobile-menu');
    const overlay = document.getElementById('mobile-overlay');
    const isOpen = !menu.classList.contains('hidden');
    if (isOpen) {
        menu.classList.add('hidden');
        overlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    } else {
        menu.classList.remove('hidden');
        overlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    lucide.createIcons();
}

function toggleApiDropdown() {
    const menu = document.getElementById('api-dropdown-menu');
    const toolsMenu = document.getElementById('tools-dropdown-menu');
    toolsMenu.classList.add('hidden');
    menu.classList.toggle('hidden');
    lucide.createIcons();
}

function toggleToolsDropdown() {
    const menu = document.getElementById('tools-dropdown-menu');
    const apiMenu = document.getElementById('api-dropdown-menu');
    apiMenu.classList.add('hidden');
    menu.classList.toggle('hidden');
    lucide.createIcons();
}

// Close dropdowns on outside click
document.addEventListener('click', (e) => {
    if (!document.getElementById('api-dropdown').contains(e.target)) {
        document.getElementById('api-dropdown-menu').classList.add('hidden');
    }
    if (!document.getElementById('tools-dropdown').contains(e.target)) {
        document.getElementById('tools-dropdown-menu').classList.add('hidden');
    }
});

// Close mobile menu on resize to desktop
window.addEventListener('resize', () => {
    if (window.innerWidth >= 1280) {
        document.getElementById('mobile-menu').classList.add('hidden');
        document.getElementById('mobile-overlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
});

// ─── Update checker ─────────────────────────────────────────────────────────
(function checkForUpdates() {
    fetch('/api/check-update')
        .then(r => r.json())
        .then(data => {
            if (!data.update_available) return;

            const banner = document.getElementById('update-banner');
            const summary = document.getElementById('update-summary');
            const changelog = document.getElementById('update-changelog');
            const cmd = document.getElementById('update-cmd');

            summary.textContent = `${data.commits_behind} new commit${data.commits_behind !== 1 ? 's' : ''} — ${data.current_version} → ${data.latest_version}`;

            // Render changelog
            changelog.innerHTML = '';
            (data.changelog || []).forEach(c => {
                const div = document.createElement('div');
                div.className = 'flex items-start gap-3 text-sm';
                div.innerHTML = `
                    <span class="font-mono text-xs text-indigo-400 bg-indigo-900/40 px-2 py-0.5 rounded flex-shrink-0 mt-0.5">${c.sha}</span>
                    <span class="text-gray-300">${c.message}</span>`;
                changelog.appendChild(div);
            });

            // Set update command
            cmd.textContent = data.update_commands || '';

            banner.classList.remove('hidden');
            lucide.createIcons();
        })
        .catch(() => {}); // Silently fail
})();

function runUpdate() {
    const btn = document.getElementById('update-now-btn');
    const origText = btn.textContent;
    btn.textContent = 'Updating...';
    btn.disabled = true;
    btn.classList.add('opacity-60', 'cursor-not-allowed');

    fetch('/api/run-update', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                btn.textContent = '✓ Updated! Restarting...';
                btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
                btn.classList.add('bg-green-600');
                // Server restarts in ~2s, reload page after 5s
                setTimeout(() => { window.location.reload(); }, 5000);
            } else {
                btn.textContent = 'Failed — see console';
                btn.classList.remove('bg-indigo-600');
                btn.classList.add('bg-red-600');
                console.error('Update failed:', data);
                setTimeout(() => { btn.textContent = origText; btn.disabled = false; btn.classList.remove('opacity-60','cursor-not-allowed','bg-red-600'); btn.classList.add('bg-indigo-600'); }, 5000);
            }
        })
        .catch(err => {
            // If fetch fails it might be because the server restarted mid-request — that's actually success
            btn.textContent = '✓ Restarting...';
            btn.classList.remove('bg-indigo-600');
            btn.classList.add('bg-green-600');
            setTimeout(() => { window.location.reload(); }, 5000);
        });
}
</script>
{% block attribution %}{% endblock %}
{% endblock %}
