{% extends "layout.html" %}
{% block title %}Brokers â€” {{ app_name }}{% endblock %}
{% block page_title %}Brokers{% endblock %}
{% block content %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Add Broker -->
    <div class="lg:col-span-1">
        <div class="bg-surface-900 border border-surface-800 rounded-2xl">
            <div class="px-6 py-5 border-b border-surface-800 flex flex-row items-center gap-3">
                <i data-lucide="plus-circle" class="w-5 h-5 text-brand-400 flex-shrink-0"></i>
                <h3 class="text-base font-semibold text-white">Add Broker</h3>
            </div>
            <form method="POST" action="/brokers/add" class="p-6 space-y-5">
                <div>
                    <label class="block text-sm font-medium text-surface-300 mb-2">TradeLocker Email</label>
                    <input type="email" name="email" required
                        class="w-full px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-xl text-white text-sm
                               focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent
                               placeholder-surface-400 transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-surface-300 mb-2">Password</label>
                    <input type="password" name="password" required
                        class="w-full px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-xl text-white text-sm
                               focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent
                               placeholder-surface-400 transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-surface-300 mb-2">Server</label>
                    <input type="text" name="server" required
                        class="w-full px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-xl text-white text-sm
                               focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent
                               placeholder-surface-400 transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-surface-300 mb-2">Environment</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex flex-row items-center gap-2 px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-xl cursor-pointer hover:border-surface-500 transition text-sm">
                            <input type="radio" name="environment" value="demo" checked class="text-brand-500 focus:ring-brand-500 bg-surface-700 border-surface-500">
                            <span class="text-surface-200">Demo</span>
                        </label>
                        <label class="flex flex-row items-center gap-2 px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-xl cursor-pointer hover:border-surface-500 transition text-sm">
                            <input type="radio" name="environment" value="live" class="text-brand-500 focus:ring-brand-500 bg-surface-700 border-surface-500">
                            <span class="text-surface-200">Live</span>
                        </label>
                    </div>
                </div>
                <button type="submit"
                    class="w-full py-3 px-4 bg-brand-600 hover:bg-brand-500 text-white text-sm font-semibold
                           rounded-xl transition-all shadow-lg shadow-brand-600/20 flex flex-row items-center justify-center gap-2">
                    <i data-lucide="link" class="w-4 h-4 flex-shrink-0"></i>
                    <span>Connect Broker</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Broker List -->
    <div class="lg:col-span-2 space-y-5">
        {% if credentials|length == 0 %}
        <div class="bg-surface-900 border border-surface-800 rounded-2xl">
            <div class="text-center py-20 px-6">
                <div class="w-16 h-16 rounded-2xl bg-surface-800 flex items-center justify-center mx-auto mb-5">
                    <i data-lucide="landmark" class="w-8 h-8 text-surface-400"></i>
                </div>
                <p class="text-white text-base font-medium">No brokers connected</p>
                <p class="text-surface-400 text-sm mt-2">Add your TradeLocker credentials to get started.</p>
            </div>
        </div>
        {% else %}
            {% for cred in credentials %}
            <div class="bg-surface-900 border border-surface-800 rounded-2xl overflow-hidden">
                <!-- Broker header -->
                <div class="px-6 py-5 border-b border-surface-800 flex flex-row items-center justify-between">
                    <div class="flex flex-row items-center gap-4">
                        <div class="w-11 h-11 rounded-xl flex items-center justify-center
                            {% if cred.environment == 'live' %}bg-green-600/15{% else %}bg-blue-600/15{% endif %}">
                            <i data-lucide="landmark" class="w-5 h-5
                                {% if cred.environment == 'live' %}text-green-400{% else %}text-blue-400{% endif %}"></i>
                        </div>
                        <div>
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-sm font-semibold text-white">{{ cred.email }}</span>
                                <span class="text-xs px-2.5 py-1 rounded-full font-semibold
                                    {% if cred.environment == 'live' %}bg-green-900/40 text-green-400 border border-green-800
                                    {% else %}bg-blue-900/40 text-blue-400 border border-blue-800{% endif %}">
                                    {{ cred.environment }}
                                </span>
                            </div>
                            <p class="text-xs text-surface-400 mt-1">{{ cred.server }}</p>
                        </div>
                    </div>
                    <div class="flex flex-row items-center gap-2">
                        <form method="POST" action="/brokers/refresh/{{ cred.id }}" class="inline">
                            <button type="submit"
                                class="flex flex-row items-center gap-2 text-sm text-surface-300 hover:text-white
                                       border border-surface-700 hover:border-surface-500 px-4 py-2 rounded-xl transition">
                                <i data-lucide="refresh-cw" class="w-4 h-4 flex-shrink-0"></i>
                                <span>Refresh</span>
                            </button>
                        </form>
                        <form method="POST" action="/brokers/delete/{{ cred.id }}" class="inline"
                              onsubmit="return confirm('Remove this broker and all its accounts?')">
                            <button type="submit"
                                class="flex flex-row items-center gap-2 text-sm text-red-400 hover:text-red-300
                                       border border-surface-700 hover:border-red-800 px-4 py-2 rounded-xl transition">
                                <i data-lucide="trash-2" class="w-4 h-4 flex-shrink-0"></i>
                                <span>Remove</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Accounts -->
                {% if cred.accounts|length > 0 %}
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-xs uppercase tracking-widest text-surface-400 border-b border-surface-800">
                                <th class="text-left py-4 px-6 font-semibold">Arrissa ID</th>
                                <th class="text-left py-4 px-6 font-semibold">Account</th>
                                <th class="text-left py-4 px-6 font-semibold">Nickname</th>
                                <th class="text-left py-4 px-6 font-semibold">Currency</th>
                                <th class="text-left py-4 px-6 font-semibold">Status</th>
                                <th class="text-right py-4 px-6 font-semibold">Balance</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-surface-800">
                            {% for acc in cred.accounts %}
                            <tr class="hover:bg-surface-800/50 transition-colors">
                                <td class="py-4 px-6">
                                    <span class="text-xs font-mono text-brand-400">{{ acc.arrissa_id }}</span>
                                </td>
                                <td class="py-4 px-6">
                                    <span class="text-sm font-medium text-white">{{ acc.name or acc.account_id }}</span>
                                    <span class="text-surface-400 text-xs ml-2">#{{ acc.acc_num }}</span>
                                </td>
                                <td class="py-4 px-6">
                                    <form method="POST" action="/brokers/account/{{ acc.arrissa_id }}/nickname"
                                          class="flex flex-row items-center gap-2">
                                        <input type="text" name="nickname" value="{{ acc.nickname or '' }}"
                                            placeholder="e.g. My Demo"
                                            class="w-28 px-2.5 py-1.5 bg-surface-800 border border-surface-700 rounded-lg text-white text-xs
                                                   focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent
                                                   placeholder-surface-500 transition">
                                        <button type="submit"
                                            class="px-2 py-1.5 text-xs bg-brand-600/30 hover:bg-brand-600/50 text-brand-400 rounded-lg transition"
                                            title="Save nickname">
                                            <i data-lucide="check" class="w-3 h-3"></i>
                                        </button>
                                    </form>
                                </td>
                                <td class="py-4 px-6 text-sm text-surface-200">{{ acc.currency }}</td>
                                <td class="py-4 px-6">
                                    <span class="text-xs px-2.5 py-1 rounded-full font-semibold
                                        {% if acc.status == 'ACTIVE' %}bg-green-900/40 text-green-400
                                        {% else %}bg-amber-900/40 text-amber-400{% endif %}">
                                        {{ acc.status }}
                                    </span>
                                </td>
                                <td class="py-4 px-6 text-right text-white font-mono text-base font-semibold">{{ acc.account_balance }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="px-6 py-8 text-center">
                    <p class="text-surface-400 text-sm">No accounts found for this broker.</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

{% endblock %}
