{% extends "layout.html" %}
{% block title %}Settings — {{ app_name }}{% endblock %}
{% block page_title %}Settings{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto space-y-6">

    <!-- Flash messages -->
    {% if message %}
    <div class="flex flex-row items-center gap-3 bg-green-900/30 border border-green-800 rounded-xl px-5 py-4">
        <i data-lucide="check-circle-2" class="w-5 h-5 text-green-400 flex-shrink-0"></i>
        <p class="text-sm text-green-300">{{ message }}</p>
    </div>
    {% endif %}
    {% if error %}
    <div class="flex flex-row items-center gap-3 bg-red-900/30 border border-red-800 rounded-xl px-5 py-4">
        <i data-lucide="alert-circle" class="w-5 h-5 text-red-400 flex-shrink-0"></i>
        <p class="text-sm text-red-300">{{ error }}</p>
    </div>
    {% endif %}

    <!-- Site URL Section -->
    <div class="bg-surface-900 border border-surface-800 rounded-2xl">
        <div class="px-6 py-5 border-b border-surface-800 flex flex-row items-center gap-3">
            <i data-lucide="globe" class="w-5 h-5 text-brand-400 flex-shrink-0"></i>
            <h3 class="text-base font-semibold text-white">Site URL</h3>
        </div>
        <div class="p-6 space-y-4">
            <p class="text-sm text-surface-300">
                The base URL where this app is accessible. All API examples and code snippets will use this URL.
                Change it when you deploy behind a reverse proxy (e.g. <span class="font-mono text-brand-400">https://data.arrissadata.com</span>).
            </p>
            <form method="POST" action="/settings/update-site-url" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-surface-400 uppercase tracking-wider mb-2">Base URL</label>
                    <input type="url" name="site_url" value="{{ site_url }}" required
                        placeholder="http://localhost:5001"
                        class="w-full px-4 py-3 bg-surface-800 border border-surface-700 rounded-xl text-white font-mono text-sm
                               focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition">
                </div>
                <div class="flex flex-row items-center gap-3">
                    <button type="submit"
                        class="flex flex-row items-center gap-2 text-sm text-white bg-brand-600 hover:bg-brand-500
                               px-5 py-2.5 rounded-xl transition font-medium">
                        <i data-lucide="save" class="w-4 h-4 flex-shrink-0"></i>
                        <span>Save URL</span>
                    </button>
                    <p class="text-xs text-surface-400">No trailing slash needed</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Default Trading Account Section -->
    <div class="bg-surface-900 border border-surface-800 rounded-2xl">
        <div class="px-6 py-5 border-b border-surface-800 flex flex-row items-center gap-3">
            <i data-lucide="wallet" class="w-5 h-5 text-brand-400 flex-shrink-0"></i>
            <h3 class="text-base font-semibold text-white">Default Trading Account</h3>
        </div>
        <div class="p-6 space-y-4">
            <p class="text-sm text-surface-300">
                Choose which trading account to use by default for all API calls, MCP tools, and TMP queries
                when no account is explicitly specified. If not set, the first available account is used automatically.
            </p>
            <form method="POST" action="/settings/update-default-account" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-surface-400 uppercase tracking-wider mb-2">Account</label>
                    <select name="default_account_id"
                        class="w-full px-4 py-3 bg-surface-800 border border-surface-700 rounded-xl text-white text-sm
                               focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition appearance-none cursor-pointer">
                        <option value="" {% if not default_account_id %}selected{% endif %} class="text-surface-400">
                            Auto (first available account)
                        </option>
                        {% for acc in accounts %}
                        <option value="{{ acc.arrissa_id }}"
                                {% if default_account_id == acc.arrissa_id %}selected{% endif %}>
                            {{ acc.arrissa_id }} — {{ acc.nickname or acc.name or acc.acc_num }}
                            {% if acc.currency %}({{ acc.currency }}){% endif %}
                            {% if acc.credential and acc.credential.environment %}· {{ acc.credential.environment }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% if accounts | length == 0 %}
                <p class="text-xs text-surface-400">No trading accounts connected yet. Add one on the
                    <a href="/brokers" class="text-brand-400 hover:text-brand-300 underline">Brokers</a> page.</p>
                {% endif %}
                <div class="flex flex-row items-center gap-3">
                    <button type="submit"
                        class="flex flex-row items-center gap-2 text-sm text-white bg-brand-600 hover:bg-brand-500
                               px-5 py-2.5 rounded-xl transition font-medium">
                        <i data-lucide="save" class="w-4 h-4 flex-shrink-0"></i>
                        <span>Save Default Account</span>
                    </button>
                    {% if default_account_id %}
                    <p class="text-xs text-surface-400">Currently: <span class="font-mono text-brand-400">{{ default_account_id }}</span></p>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- API Key Section -->
    <div class="bg-surface-900 border border-surface-800 rounded-2xl">
        <div class="px-6 py-5 border-b border-surface-800 flex flex-row items-center gap-3">
            <i data-lucide="key" class="w-5 h-5 text-brand-400 flex-shrink-0"></i>
            <h3 class="text-base font-semibold text-white">Your API Key</h3>
        </div>
        <div class="p-6 space-y-5">
            <p class="text-sm text-surface-300">Use this key in the <span class="font-mono text-brand-400">X-API-Key</span> header to authenticate your API requests.</p>

            <!-- API Key Display -->
            <div class="flex flex-row items-center gap-3">
                <div class="flex-1 relative">
                    <input id="apiKeyField" type="text" readonly value="{{ api_key }}"
                        class="w-full px-4 py-3 bg-surface-800 border border-surface-700 rounded-xl text-white font-mono text-sm
                               focus:outline-none select-all pr-12">
                    <button onclick="copyApiKey()" id="copyBtn" type="button"
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-surface-400 hover:text-white transition"
                        title="Copy to clipboard">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- Copy feedback -->
            <p id="copyFeedback" class="text-xs text-green-400 hidden">Copied to clipboard</p>

            <!-- Regenerate -->
            <div class="pt-2 border-t border-surface-800">
                <div class="flex flex-row items-center justify-between">
                    <div>
                        <p class="text-sm text-surface-200 font-medium">Regenerate API Key</p>
                        <p class="text-xs text-surface-400 mt-1">This will invalidate your current key. Any integrations using it will stop working.</p>
                    </div>
                    <form method="POST" action="/settings/regenerate-key"
                          onsubmit="return confirm('Are you sure? Your current API key will be permanently invalidated.')">
                        <button type="submit"
                            class="flex flex-row items-center gap-2 text-sm text-amber-400 hover:text-amber-300
                                   border border-surface-700 hover:border-amber-800 px-4 py-2.5 rounded-xl transition">
                            <i data-lucide="refresh-cw" class="w-4 h-4 flex-shrink-0"></i>
                            <span>Regenerate</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Section -->
    <div class="bg-surface-900 border border-surface-800 rounded-2xl">
        <div class="px-6 py-5 border-b border-surface-800 flex flex-row items-center gap-3">
            <i data-lucide="lock" class="w-5 h-5 text-brand-400 flex-shrink-0"></i>
            <h3 class="text-base font-semibold text-white">Change Password</h3>
        </div>
        <div class="p-6">
            <form method="POST" action="/settings/change-password" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-surface-400 uppercase tracking-wider mb-2">Current Password</label>
                    <input type="password" name="current_password" required autocomplete="current-password"
                        class="w-full px-4 py-3 bg-surface-800 border border-surface-700 rounded-xl text-white text-sm
                               focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-surface-400 uppercase tracking-wider mb-2">New Password</label>
                    <input type="password" name="new_password" required minlength="6" autocomplete="new-password"
                        class="w-full px-4 py-3 bg-surface-800 border border-surface-700 rounded-xl text-white text-sm
                               focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-surface-400 uppercase tracking-wider mb-2">Confirm New Password</label>
                    <input type="password" name="confirm_password" required minlength="6" autocomplete="new-password"
                        class="w-full px-4 py-3 bg-surface-800 border border-surface-700 rounded-xl text-white text-sm
                               focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition">
                </div>
                <button type="submit"
                    class="flex flex-row items-center gap-2 text-sm text-white bg-brand-600 hover:bg-brand-500
                           px-5 py-2.5 rounded-xl transition font-medium">
                    <i data-lucide="shield-check" class="w-4 h-4 flex-shrink-0"></i>
                    <span>Update Password</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Usage Example -->
    <div class="bg-surface-900 border border-surface-800 rounded-2xl">
        <div class="px-6 py-5 border-b border-surface-800 flex flex-row items-center gap-3">
            <i data-lucide="code" class="w-5 h-5 text-brand-400 flex-shrink-0"></i>
            <h3 class="text-base font-semibold text-white">Usage Example</h3>
        </div>
        <div class="p-6">
            <pre class="bg-surface-800 border border-surface-700 rounded-xl p-4 text-sm font-mono text-surface-200 overflow-x-auto"><code>curl -H "X-API-Key: <span class="text-brand-400">YOUR_API_KEY</span>" \
     {{ site_url }}/users/1/tradelocker/accounts</code></pre>
        </div>
    </div>

</div>

<script>
function copyApiKey() {
    const field = document.getElementById('apiKeyField');
    navigator.clipboard.writeText(field.value).then(() => {
        const fb = document.getElementById('copyFeedback');
        fb.classList.remove('hidden');
        setTimeout(() => fb.classList.add('hidden'), 2000);
    });
}
</script>

{% endblock %}
