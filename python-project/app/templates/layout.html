{% extends "base.html" %}
{% block body %}
<div class="flex min-h-screen">

    <!-- Mobile overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-surface-900 border-r border-surface-800 flex flex-col fixed h-full z-40
                               transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
        <!-- Logo -->
        <div class="px-6 border-b border-surface-800 flex-shrink-0" style="padding-top: 1.2rem; padding-bottom: 1.2rem;">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-brand-600 flex items-center justify-center">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="text-xl font-bold text-white tracking-tight">{{ app_name }}</span>
                </div>
                <!-- Close button (mobile only) -->
                <button onclick="toggleSidebar()" class="lg:hidden p-1 rounded-lg text-surface-400 hover:text-white hover:bg-surface-800 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Nav (scrollable) -->
        <nav class="flex-1 px-4 py-6 overflow-y-auto scrollbar-thin">
            <p class="text-xs font-semibold text-surface-400 uppercase tracking-widest mb-4 px-3">Menu</p>

            <a href="/dashboard"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'dashboard' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="layout-dashboard" class="w-5 h-5 flex-shrink-0"></i>
                <span>Dashboard</span>
            </a>

            <a href="/brokers"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'brokers' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="landmark" class="w-5 h-5 flex-shrink-0"></i>
                <span>Brokers</span>
            </a>

            <a href="/instruments-api"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'instruments_api' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="file-code" class="w-5 h-5 flex-shrink-0"></i>
                <span>Instruments API</span>
            </a>

            <a href="/account-details-api"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'account_details_api' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="user-circle" class="w-5 h-5 flex-shrink-0"></i>
                <span>Account Details API</span>
            </a>

            <a href="/order-api"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'order_api' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="list-ordered" class="w-5 h-5 flex-shrink-0"></i>
                <span>Order API</span>
            </a>

            <a href="/trading-api"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'trading_api' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="arrow-left-right" class="w-5 h-5 flex-shrink-0"></i>
                <span>Trading API</span>
            </a>

            <a href="/market-data-api"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'market_data_api' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="candlestick-chart" class="w-5 h-5 flex-shrink-0"></i>
                <span>Market Data API</span>
            </a>

            <a href="/chart-image-api"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'chart_image_api' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="image" class="w-5 h-5 flex-shrink-0"></i>
                <span>Chart Image API</span>
            </a>

            <a href="/news-api"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'news_api' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="newspaper" class="w-5 h-5 flex-shrink-0"></i>
                <span>News API</span>
            </a>

            <a href="/event-ids"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'event_ids' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="hash" class="w-5 h-5 flex-shrink-0"></i>
                <span>Event ID Reference</span>
            </a>

            <a href="/scrape-api"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'scrape_api' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="globe" class="w-5 h-5 flex-shrink-0"></i>
                <span>Scrape API</span>
            </a>

            <a href="/mcp-server"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'mcp_server' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="cpu" class="w-5 h-5 flex-shrink-0"></i>
                <span>MCP Server</span>
            </a>

            <a href="/asp-guide"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'asp_guide' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="search" class="w-5 h-5 flex-shrink-0"></i>
                <span>ASP Protocol</span>
            </a>

            <a href="/install"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'install' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="download" class="w-5 h-5 flex-shrink-0"></i>
                <span>Install Guide</span>
            </a>

            <a href="/settings"
               class="flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-base font-medium transition-all duration-200 mb-2
                      {% if active_page == 'settings' %}bg-brand-600 text-white shadow-lg shadow-brand-600/25{% else %}text-surface-200 hover:bg-surface-800 hover:text-white{% endif %}">
                <i data-lucide="settings" class="w-5 h-5 flex-shrink-0"></i>
                <span>Settings</span>
            </a>
        </nav>

        <!-- Sidebar footer — attribution required by license -->
        <div class="px-4 py-5 border-t border-surface-800 flex-shrink-0" id="arrissa-credit">
            <p class="text-xs text-surface-400 text-center">&copy; 2026 {{ app_name }} &middot; v1.0</p>
            <p class="text-[10px] text-surface-500 text-center mt-1" data-arrissa="vestorfinance">
                Powered by <a href="https://arrissadata.com" target="_blank" class="text-surface-400 hover:text-brand-400 transition">Arrissa</a>
                &middot; <a href="https://arrissa.trade" target="_blank" class="text-surface-400 hover:text-brand-400 transition">arrissa.trade</a>
            </p>
            <p class="text-[10px] text-surface-500 text-center mt-0.5">
                Created by <a href="https://arrissacapital.com" target="_blank" class="text-surface-400 hover:text-brand-400 transition">Arrissa Pty Ltd</a>
                &middot; <a href="https://x.com/mystprevail" target="_blank" class="text-surface-400 hover:text-brand-400 transition">@mystprevail</a>
            </p>
        </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 lg:ml-64">
        <!-- Top bar -->
        <header class="sticky top-0 z-20 bg-surface-950/80 backdrop-blur-md border-b border-surface-800">
            <div class="flex items-center justify-between px-4 sm:px-6 lg:px-10 py-4 lg:py-5">
                <div class="flex items-center gap-3">
                    <!-- Hamburger button (mobile only) -->
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg text-surface-400 hover:text-white hover:bg-surface-800 transition-colors">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                    </button>
                    <h2 class="text-lg lg:text-xl font-bold text-white">{% block page_title %}Dashboard{% endblock %}</h2>
                </div>

                <div class="flex items-center gap-3 lg:gap-5">
                    <div class="hidden sm:flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-brand-600/20 flex items-center justify-center">
                            <i data-lucide="user" class="w-4 h-4 text-brand-400"></i>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-white leading-tight">{{ user.first_name }} {{ user.last_name }}</p>
                            <p class="text-xs text-surface-400">{{ user.email }}</p>
                        </div>
                    </div>
                    <a href="/logout"
                       class="flex flex-row items-center gap-2 text-sm text-surface-400 hover:text-white border border-surface-700 hover:border-surface-400 px-3 lg:px-4 py-2 rounded-lg transition-all duration-200">
                        <i data-lucide="log-out" class="w-4 h-4 flex-shrink-0"></i>
                        <span class="hidden sm:inline">Sign Out</span>
                    </a>
                </div>
            </div>
        </header>

        <div class="px-4 sm:px-6 lg:px-10 py-6 lg:py-8">
            <!-- Update notification banner -->
            <div id="update-banner" class="hidden mb-6 bg-indigo-900/30 border border-indigo-700/50 rounded-2xl overflow-hidden">
                <div class="px-5 py-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-indigo-600/30 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="download-cloud" class="w-5 h-5 text-indigo-400"></i>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-white">Update Available</p>
                            <p class="text-xs text-indigo-300" id="update-summary"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <button onclick="document.getElementById('update-details').classList.toggle('hidden'); lucide.createIcons();"
                            class="text-xs text-indigo-300 hover:text-white px-3 py-1.5 bg-indigo-800/40 hover:bg-indigo-700/50 rounded-lg transition">
                            View Changes
                        </button>
                        <button id="update-now-btn" onclick="runUpdate()"
                            class="text-xs text-white font-semibold px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg transition">
                            Update Now
                        </button>
                        <button onclick="document.getElementById('update-banner').classList.add('hidden')"
                            class="text-xs text-indigo-400 hover:text-white p-1.5 rounded-lg transition">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Expandable details -->
                <div id="update-details" class="hidden border-t border-indigo-700/30">
                    <!-- Changelog -->
                    <div class="px-5 py-4">
                        <p class="text-xs font-semibold text-indigo-300 uppercase tracking-wider mb-3">What's New</p>
                        <div id="update-changelog" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    </div>
                    <!-- Update command -->
                    <div class="px-5 py-4 bg-gray-950/50 border-t border-indigo-700/30">
                        <p class="text-xs font-semibold text-indigo-300 uppercase tracking-wider mb-2">Update Command</p>
                        <p class="text-xs text-gray-400 mb-3">SSH into your server and paste this command:</p>
                        <div class="relative">
                            <pre id="update-cmd" class="bg-gray-900 border border-gray-700 rounded-xl p-4 text-sm font-mono text-green-400 overflow-x-auto whitespace-pre-wrap pr-16"></pre>
                            <button onclick="navigator.clipboard.writeText(document.getElementById('update-cmd').textContent).then(()=>{this.textContent='Copied!'; setTimeout(()=>this.textContent='Copy',2000)})"
                                class="absolute top-3 right-3 text-xs text-gray-400 hover:text-indigo-400 px-3 py-1.5 bg-gray-800 rounded-lg transition">Copy</button>
                        </div>
                    </div>
                </div>
            </div>

            {% if message %}
            <div class="flash-msg flex flex-row items-center gap-3 bg-green-900/30 border border-green-800 text-green-300 px-5 py-4 rounded-xl mb-6 text-sm transition-opacity duration-500">
                <i data-lucide="check-circle-2" class="w-5 h-5 flex-shrink-0"></i>
                <span>{{ message }}</span>
            </div>
            {% endif %}
            {% if error %}
            <div class="flash-msg flex flex-row items-center gap-3 bg-red-900/30 border border-red-800 text-red-300 px-5 py-4 rounded-xl mb-6 text-sm transition-opacity duration-500">
                <i data-lucide="alert-circle" class="w-5 h-5 flex-shrink-0"></i>
                <span>{{ error }}</span>
            </div>
            {% endif %}

            {% block content %}{% endblock %}
        </div>
    </main>
</div>

<script>
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const isOpen = !sidebar.classList.contains('-translate-x-full');
    if (isOpen) {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    } else {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    // Re-init lucide icons for any newly visible elements
    lucide.createIcons();
}
// Close sidebar on window resize to desktop
window.addEventListener('resize', () => {
    if (window.innerWidth >= 1024) {
        document.getElementById('sidebar').classList.remove('-translate-x-full');
        document.getElementById('sidebar-overlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    } else {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        }
    }
});

// ─── Update checker ─────────────────────────────────────────────────────────
(function checkForUpdates() {
    fetch('/api/check-update')
        .then(r => r.json())
        .then(data => {
            if (!data.update_available) return;

            const banner = document.getElementById('update-banner');
            const summary = document.getElementById('update-summary');
            const changelog = document.getElementById('update-changelog');
            const cmd = document.getElementById('update-cmd');

            summary.textContent = `${data.commits_behind} new commit${data.commits_behind !== 1 ? 's' : ''} — ${data.current_version} → ${data.latest_version}`;

            // Render changelog
            changelog.innerHTML = '';
            (data.changelog || []).forEach(c => {
                const div = document.createElement('div');
                div.className = 'flex items-start gap-3 text-sm';
                div.innerHTML = `
                    <span class="font-mono text-xs text-indigo-400 bg-indigo-900/40 px-2 py-0.5 rounded flex-shrink-0 mt-0.5">${c.sha}</span>
                    <span class="text-gray-300">${c.message}</span>`;
                changelog.appendChild(div);
            });

            // Set update command
            cmd.textContent = data.update_commands || '';

            banner.classList.remove('hidden');
            lucide.createIcons();
        })
        .catch(() => {}); // Silently fail
})();

function runUpdate() {
    const btn = document.getElementById('update-now-btn');
    const origText = btn.textContent;
    btn.textContent = 'Updating...';
    btn.disabled = true;
    btn.classList.add('opacity-60', 'cursor-not-allowed');

    fetch('/api/run-update', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                btn.textContent = '✓ Updated! Restarting...';
                btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
                btn.classList.add('bg-green-600');
                // Server restarts in ~2s, reload page after 5s
                setTimeout(() => { window.location.reload(); }, 5000);
            } else {
                btn.textContent = 'Failed — see console';
                btn.classList.remove('bg-indigo-600');
                btn.classList.add('bg-red-600');
                console.error('Update failed:', data);
                setTimeout(() => { btn.textContent = origText; btn.disabled = false; btn.classList.remove('opacity-60','cursor-not-allowed','bg-red-600'); btn.classList.add('bg-indigo-600'); }, 5000);
            }
        })
        .catch(err => {
            // If fetch fails it might be because the server restarted mid-request — that's actually success
            btn.textContent = '✓ Restarting...';
            btn.classList.remove('bg-indigo-600');
            btn.classList.add('bg-green-600');
            setTimeout(() => { window.location.reload(); }, 5000);
        });
}
</script>
{% endblock %}
